<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Other data type &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Control flow statements" href="ctrlflow.html" />
    <link rel="prev" title="Global variables" href="globalvar.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Other data type</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="other-data-type">
<span id="sec-othertypesupport"></span><h1>Other data type<a class="headerlink" href="#other-data-type" title="Permalink to this headline">¶</a></h1>
<p>Until now, we only handle the type int and long of 32 bits size.
This chapter introduce other type such as pointer, char, long long which are not
32 bits size.</p>
<div class="section" id="local-variable-pointer">
<h2>Local variable pointer<a class="headerlink" href="#local-variable-pointer" title="Permalink to this headline">¶</a></h2>
<p>To support pointer to local variable, add this code fragment in
Cpu0InstrInfo.td and Cpu0InstPrinter.cpp as follows,</p>
<p class="rubric">lbdex/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>def mem_ea : Operand&lt;i32&gt; {
  let PrintMethod = "printMemOperandEA";
  let MIOperandInfo = (ops CPURegs, simm16);
  let EncoderMethod = "getMemEncoding";
}
...
class EffectiveAddress&lt;string instr_asm, RegisterClass RC, Operand Mem&gt; :
  FMem&lt;0x09, (outs RC:$ra), (ins Mem:$addr),
     instr_asm, [(set RC:$ra, addr:$addr)], IIAlu&gt;;
...
// FrameIndexes are legalized when they are operands from load/store
// instructions. The same not happens for stack address copies, so an
// add op with mem ComplexPattern is used and the stack address copy
// can be matched. It's similar to Sparc LEA_ADDRi
def LEA_ADDiu : EffectiveAddress&lt;"addiu\t$ra, $addr", CPURegs, mem_ea&gt; {
  let isCodeGenOnly = 1;
}</pre>
</div>
<p class="rubric">lbdex/Chapter7_1/Cpu0InstPrinter.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span>
<span class="n">printMemOperandEA</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// when using stack locations for not load/store instructions</span>
  <span class="c1">// print the same way as all normal 3 operand instructions.</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run ch7_1.cpp with code Chapter7_1/ which support pointer to local variable,
will get result as follows,</p>
<p class="rubric">lbdex/InputFiles/ch7_1.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">test_local_pointer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  
  <span class="kt">int</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>

  <span class="k">return</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-66-82:InputFiles Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch7_1.cpp -emit-llvm -o ch7_1.bc
118-165-66-82:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_
debug_build/bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm
  ch7_1.bc -o ch7_1.cpu0.s
  118-165-66-82:InputFiles Jonathan<span class="nv">$ </span>cat ch7_1.cpu0.s
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch7_1.bc&quot;</span>
  .text
  .globl  _Z18test_local_pointerv
  .align  2
  .type _Z18test_local_pointerv,@function
  .ent  _Z18test_local_pointerv <span class="c"># @_Z18test_local_pointerv</span>
_Z18test_local_pointerv:
  .frame  <span class="nv">$sp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 3
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$sp</span>, 4
  st  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  _Z18test_local_pointerv
<span class="nv">$tmp1</span>:
  .size _Z18test_local_pointerv, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-_Z18test_local_pointerv
</pre></div>
</div>
</div>
<div class="section" id="char-short-int-and-bool">
<h2>char, short int and bool<a class="headerlink" href="#char-short-int-and-bool" title="Permalink to this headline">¶</a></h2>
<p>To support signed/unsigned char and short int, we add the following code to
Chapter7_1/.</p>
<p class="rubric">lbdex/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">sextloadi16_a</span>   <span class="o">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">sextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">zextloadi16_a</span>   <span class="o">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">zextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">extloadi16_a</span>    <span class="o">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">extloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">def</span> <span class="n">truncstorei16_a</span> <span class="o">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">truncstorei16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">defm</span> <span class="n">LB</span>     <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x03</span><span class="p">,</span> <span class="s">&quot;lb&quot;</span><span class="p">,</span>  <span class="n">sextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LBu</span>    <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x04</span><span class="p">,</span> <span class="s">&quot;lbu&quot;</span><span class="p">,</span> <span class="n">zextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">SB</span>     <span class="o">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x05</span><span class="p">,</span> <span class="s">&quot;sb&quot;</span><span class="p">,</span> <span class="n">truncstorei8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LH</span>     <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x06</span><span class="p">,</span> <span class="s">&quot;lh&quot;</span><span class="p">,</span>  <span class="n">sextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LHu</span>    <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x07</span><span class="p">,</span> <span class="s">&quot;lhu&quot;</span><span class="p">,</span> <span class="n">zextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">SH</span>     <span class="o">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x08</span><span class="p">,</span> <span class="s">&quot;sh&quot;</span><span class="p">,</span> <span class="n">truncstorei16_a</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_2.cpp will get the following result.</p>
<p class="rubric">lbdex/InputFiles/ch7_2.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="kt">short</span> <span class="n">year</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">month</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">day</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hour</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">minute</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">test_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">Date</span> <span class="n">date1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">25</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">15</span><span class="p">};</span>
  <span class="kt">char</span> <span class="n">m</span> <span class="o">=</span> <span class="n">date1</span><span class="p">.</span><span class="n">month</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">s</span> <span class="o">=</span> <span class="n">date1</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-64-245:InputFiles Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch7_3.cpp -emit-llvm -o ch7_2.bc
118-165-64-245:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch7_2.bc -o -
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch7_2.bc&quot;</span>
  .text
  .globl  _Z9test_charv
  .align  2
  .type _Z9test_charv,@function
  .ent  _Z9test_charv           <span class="c"># @_Z9test_charv</span>
_Z9test_charv:
  .frame  <span class="nv">$fp</span>,24,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .cpload <span class="nv">$t9</span>
  .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -24
  lui <span class="nv">$2</span>, %got_hi<span class="o">(</span>b<span class="o">)</span>
  addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$gp</span>
  ld  <span class="nv">$2</span>, %got_lo<span class="o">(</span>b<span class="o">)(</span><span class="nv">$2</span><span class="o">)</span>
  lbu <span class="nv">$3</span>, 1<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  sb  <span class="nv">$3</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lbu <span class="nv">$2</span>, 1<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  sb  <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$2</span>, %got<span class="o">(</span><span class="nv">$_ZZ9test_charvE5date1</span><span class="o">)(</span><span class="nv">$gp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$2</span>, %lo<span class="o">(</span><span class="nv">$_ZZ9test_charvE5date1</span><span class="o">)</span>
  lhu <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  shl <span class="nv">$3</span>, <span class="nv">$3</span>, 16
  lhu <span class="nv">$4</span>, 6<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  or  <span class="nv">$3</span>, <span class="nv">$3</span>, <span class="nv">$4</span>
  st  <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span> // store hour, minute and second on 12<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  lhu <span class="nv">$3</span>, 2<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  lhu <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  shl <span class="nv">$2</span>, <span class="nv">$2</span>, 16
  or  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
  st  <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>    // store year, month and day on 8<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  lbu <span class="nv">$2</span>, 10<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>   // <span class="nv">m</span> <span class="o">=</span> date1.month;
  sb  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lbu <span class="nv">$2</span>, 14<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>   // <span class="nv">s</span> <span class="o">=</span> date1.second;
  sb  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 24
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  _Z9test_charv
<span class="nv">$tmp1</span>:
  .size _Z9test_charv, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-_Z9test_charv

  .type b,@object               <span class="c"># @b</span>
  .data
  .globl  b
b:
  .asciz   <span class="s2">&quot;abc&quot;</span>
  .size b, 4

  .type <span class="nv">$_ZZ9test_charvE5date1</span>,@object <span class="c"># @_ZZ9test_charvE5date1</span>
  .section  .rodata.cst8,<span class="s2">&quot;aM&quot;</span>,@progbits,8
  .align  1
<span class="nv">$_ZZ9test_charvE5date1</span>:
  .2byte  2012                    <span class="c"># 0x7dc</span>
  .byte 11                      <span class="c"># 0xb</span>
  .byte 25                      <span class="c"># 0x19</span>
  .byte 9                       <span class="c"># 0x9</span>
  .byte 40                      <span class="c"># 0x28</span>
  .byte 15                      <span class="c"># 0xf</span>
  .space  1
  .size <span class="nv">$_ZZ9test_charvE5date1</span>, 8
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_2_2.cpp will get the following result.</p>
<p class="rubric">lbdex/InputFiles/ch7_2_2.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">test_signed_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span><span class="mh">0x80</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// i = (-128+2) = -126</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_unsigned_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// i = (128+2) = 130</span>

  <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_signed_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">short</span> <span class="n">a</span> <span class="o">=</span><span class="mh">0x8000</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// i = (-32768+2) = -32766</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_unsigned_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// i = (32768+2) = 32770</span>

  <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>1-160-136-236:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llvm-dis ch7_2_2.bc -o -
  ...
define i32 @_Z16test_signed_charv<span class="o">()</span> <span class="c">#0 {</span>
  ...
  %1 <span class="o">=</span> load i8* %a, align 1
  %2 <span class="o">=</span> sext i8 %1 to i32
  ...
<span class="o">}</span>

; Function Attrs: nounwind
define i32 @_Z18test_unsigned_charv<span class="o">()</span> <span class="c">#0 {</span>
  ...
  %1 <span class="o">=</span> load i8* %c, align 1
  %2 <span class="o">=</span> zext i8 %1 to i32
  ...
<span class="o">}</span>

; Function Attrs: nounwind
define i32 @_Z17test_signed_shortv<span class="o">()</span> <span class="c">#0 {</span>
  ...
  %1 <span class="o">=</span> load i16* %a, align 2
  %2 <span class="o">=</span> sext i16 %1 to i32
  ...
<span class="o">}</span>

; Function Attrs: nounwind
define i32 @_Z19test_unsigned_shortv<span class="o">()</span> <span class="c">#0 {</span>
  ...
  %1 <span class="o">=</span> load i16* %c, align 2
  %2 <span class="o">=</span> zext i16 %1 to i32
  ...
<span class="o">}</span>

attributes <span class="c">#0 = { nounwind }</span>

1-160-136-236:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm ch7_2_2.bc -o -
  ...
  .globl  _Z16test_signed_charv
  ...
  lb  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  ...
  .end  _Z16test_signed_charv

  .globl  _Z18test_unsigned_charv
  ...
  lbu <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  ...
  .end  _Z18test_unsigned_charv

  .globl  _Z17test_signed_shortv
  ...
  lh  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  ...
  .end  _Z17test_signed_shortv

  .globl  _Z19test_unsigned_shortv
  ...
  lhu <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  ...
  .end  _Z19test_unsigned_shortv
  ...
</pre></div>
</div>
<p>As you can see lb/lh are for signed byte/short type while lbu/lhu are for unsigned
byte/short type. Since C type-cast or type-conversion feature, the char to int can
be finished with an Cpu0 lb efficient instruction. That&#8217;s why the lb, lbu, lh and
lhu instructions exist. Their difference have explained in Chapter 2.</p>
<p>To support load bool type, the following code added.</p>
<p class="rubric">lbdex/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="k">new</span> <span class="n">Cpu0TargetObjectFile</span><span class="p">()),</span>
    <span class="n">Subtarget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Cpu0 does not have i1 type, so use i32 for</span>
  <span class="c1">// setcc operations results (slt, sgt, ...).</span>
  <span class="n">setBooleanContents</span><span class="p">(</span><span class="n">ZeroOrOneBooleanContent</span><span class="p">);</span>
  <span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">ZeroOrNegativeOneBooleanContent</span><span class="p">);</span>

  <span class="c1">// Load extented operations for i1 types must be promoted</span>
  <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">EXTLOAD</span><span class="p">,</span>  <span class="n">MVT</span><span class="o">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
  <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ZEXTLOAD</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
  <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">SEXTLOAD</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Above code setLoadExtAction() are work enough. The setBooleanContents() purpose
as following, but I don&#8217;t know it well. Without it, the ch7_3.ll still works
as below.
The IR input file ch7_3.ll is used in testing here since the c++ version
need flow control which is not support here. File ch_run_backend.cpp include the
test fragment for bool as below.</p>
<p class="rubric">include/llvm/Target/TargetLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">enum</span> <span class="n">BooleanContent</span> <span class="p">{</span> <span class="c1">// How the target represents true/false values.</span>
    <span class="n">UndefinedBooleanContent</span><span class="p">,</span>    <span class="c1">// Only bit 0 counts, the rest can hold garbage.</span>
    <span class="n">ZeroOrOneBooleanContent</span><span class="p">,</span>        <span class="c1">// All bits zero except for bit 0.</span>
    <span class="n">ZeroOrNegativeOneBooleanContent</span> <span class="c1">// All bits equal to bit 0.</span>
  <span class="p">};</span>
<span class="p">...</span>
<span class="nl">protected:</span>
  <span class="c1">/// setBooleanContents - Specify how the target extends the result of a</span>
  <span class="c1">/// boolean value from i1 to a wider type.  See getBooleanContents.</span>
  <span class="kt">void</span> <span class="n">setBooleanContents</span><span class="p">(</span><span class="n">BooleanContent</span> <span class="n">Ty</span><span class="p">)</span> <span class="p">{</span> <span class="n">BooleanContents</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">/// setBooleanVectorContents - Specify how the target extends the result</span>
  <span class="c1">/// of a vector boolean value from a vector of i1 to a wider type.  See</span>
  <span class="c1">/// getBooleanContents.</span>
  <span class="kt">void</span> <span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">BooleanContent</span> <span class="n">Ty</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BooleanVectorContents</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/ch7_3.ll</p>
<div class="highlight-c++"><pre>define zeroext i1 @verify_load_bool() #0 {
entry:
  %retval = alloca i1, align 1
  store i1 1, i1* %retval, align 1
  %0 = load i1* %retval
  ret i1 %0
}
</pre>
</div>
<div class="highlight-bash"><div class="highlight"><pre>  118-165-64-245:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
  bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch7_3.ll -o -

  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch7_3.ll&quot;</span>
  .text
  .globl  verify_load_bool
  .align  2
  .type verify_load_bool,@function
  .ent  verify_load_bool        <span class="c"># @verify_load_bool</span>
verify_load_bool:
  .cfi_startproc
  .frame  <span class="nv">$sp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
<span class="nv">$tmp1</span>:
  .cfi_def_cfa_offset 8
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 1
  sb  <span class="nv">$2</span>, 7<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  verify_load_bool
<span class="nv">$tmp2</span>:
  .size verify_load_bool, <span class="o">(</span><span class="nv">$tmp2</span><span class="o">)</span>-verify_load_bool
  .cfi_endproc
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/ch_run_backend.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">...</span>
<span class="kt">bool</span> <span class="n">test_load_bool</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="long-long">
<h2>long long<a class="headerlink" href="#long-long" title="Permalink to this headline">¶</a></h2>
<p>Cpu0 is like Mips which long is 32-bits and long long is 64-bits for C
language type. To support long long, we add the following code to
Chapter7_1/.</p>
<p class="rubric">lbdex/Chapter7_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Select instructions not customized! Used for</span>
<span class="c1">/// expanded, promoted and normal instructions</span>
<span class="n">SDNode</span><span class="o">*</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span><span class="n">Select</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="p">...</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>

  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">SUBE</span><span class="o">:</span>
  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">ADDE</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">SDValue</span> <span class="n">InFlag</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">CmpLHS</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="n">InFlag</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">();</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">Opc</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(((</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">ADDC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">ADDE</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">SUBC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">SUBE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
           <span class="s">&quot;(ADD|SUB)E flag operand must come from (ADD|SUB)C/E insn&quot;</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="n">MOp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Opcode</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">ADDE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CmpLHS</span> <span class="o">=</span> <span class="n">InFlag</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="n">MOp</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">CmpLHS</span> <span class="o">=</span> <span class="n">InFlag</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="n">MOp</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SUBu</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">SDValue</span> <span class="n">Ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CmpLHS</span><span class="p">,</span> <span class="n">InFlag</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">};</span>

    <span class="n">SDValue</span> <span class="n">LHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">RHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">EVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">LHS</span><span class="p">.</span><span class="n">getValueType</span><span class="p">();</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">StatusWord</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CMP</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Constant1</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">VT</span><span class="p">);</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span>
                                           <span class="n">SDValue</span><span class="p">(</span><span class="n">StatusWord</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Constant1</span><span class="p">);</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">AddCarry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span>
                                              <span class="n">SDValue</span><span class="p">(</span><span class="n">Carry</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">RHS</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">SelectNodeTo</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">MOp</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">Glue</span><span class="p">,</span>
                                <span class="n">LHS</span><span class="p">,</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">AddCarry</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="c1">/// Mul with two results</span>
  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">SMUL_LOHI</span><span class="o">:</span>
  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">UMUL_LOHI</span><span class="o">:</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NodeTy</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">)</span>
      <span class="n">MultOpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">Opcode</span> <span class="o">==</span> <span class="n">ISD</span><span class="o">::</span><span class="n">UMUL_LOHI</span> <span class="o">?</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">MULTu</span> <span class="o">:</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">MULT</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">*</span><span class="p">,</span> <span class="n">SDNode</span><span class="o">*&gt;</span> <span class="n">LoHi</span> <span class="o">=</span> <span class="n">SelectMULT</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">MultOpc</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">NodeTy</span><span class="p">,</span>
                                                  <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SDValue</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">use_empty</span><span class="p">())</span>
      <span class="n">ReplaceUses</span><span class="p">(</span><span class="n">SDValue</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">LoHi</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SDValue</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">use_empty</span><span class="p">())</span>
      <span class="n">ReplaceUses</span><span class="p">(</span><span class="n">SDValue</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">LoHi</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run Chapter7_1 with ch7_4.cpp to get the result as follows,</p>
<p class="rubric">lbdex/InputFiles/ch7_4.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">long</span> <span class="kt">long</span> <span class="nf">test_longlong</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x300000002</span><span class="p">;</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x100000001</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a1</span> <span class="o">=</span> <span class="mh">0x3001000</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b1</span> <span class="o">=</span> <span class="mh">0x2001000</span><span class="p">;</span>
  
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>   <span class="c1">// c = 0x00000004,00000003</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>   <span class="c1">// d = 0x00000002,00000001</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>   <span class="c1">// e = 0x00000005,00000002</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">a1</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">b1</span><span class="p">;</span> <span class="c1">// f = 0x00060050,01000000</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="n">f</span><span class="p">);</span> <span class="c1">// (0x0006005b,01000006) = (393307,16777222)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>1-160-134-62:InputFiles Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch7_4.cpp -emit-llvm -o ch7_4.bc
1-160-134-62:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch7_4.bc -o -
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch7_4.bc&quot;</span>
  .text
  .globl  _Z13test_longlongv
  .align  2
  .type _Z13test_longlongv,@function
  .ent  _Z13test_longlongv      <span class="c"># @_Z13test_longlongv</span>
_Z13test_longlongv:
  .frame  <span class="nv">$fp</span>,56,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -56
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 2
  st  <span class="nv">$2</span>, 52<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 3
  st  <span class="nv">$2</span>, 48<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 1
  st  <span class="nv">$2</span>, 44<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  st  <span class="nv">$2</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lui <span class="nv">$2</span>, 768
  ori <span class="nv">$2</span>, <span class="nv">$2</span>, 4096
  st  <span class="nv">$2</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lui <span class="nv">$2</span>, 512
  ori <span class="nv">$2</span>, <span class="nv">$2</span>, 4096
  st  <span class="nv">$2</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$3</span>, 44<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$2</span>, 52<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addu  <span class="nv">$5</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
  ld  <span class="nv">$2</span>, 48<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$4</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  st  <span class="nv">$5</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  cmp <span class="nv">$sw</span>, <span class="nv">$5</span>, <span class="nv">$3</span>
  mfsw  <span class="nv">$3</span>
  andi  <span class="nv">$3</span>, <span class="nv">$3</span>, 1
  addu  <span class="nv">$3</span>, <span class="nv">$3</span>, <span class="nv">$4</span>
  addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
  st  <span class="nv">$2</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$3</span>, 44<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$4</span>, 52<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  subu  <span class="nv">$t9</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
  ld  <span class="nv">$2</span>, 48<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$5</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  st  <span class="nv">$t9</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  cmp <span class="nv">$sw</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
  mfsw  <span class="nv">$3</span>
  andi  <span class="nv">$3</span>, <span class="nv">$3</span>, 1
  addu  <span class="nv">$3</span>, <span class="nv">$3</span>, <span class="nv">$5</span>
  subu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
  st  <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$2</span>, 44<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$3</span>, 52<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  multu <span class="nv">$3</span>, <span class="nv">$2</span>
  mflo  <span class="nv">$t9</span>
  mfhi  <span class="nv">$4</span>
  ld  <span class="nv">$5</span>, 48<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$t0</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  st  <span class="nv">$t9</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  mul <span class="nv">$3</span>, <span class="nv">$3</span>, <span class="nv">$t0</span>
  addu  <span class="nv">$3</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
  mul <span class="nv">$2</span>, <span class="nv">$5</span>, <span class="nv">$2</span>
  addu  <span class="nv">$2</span>, <span class="nv">$3</span>, <span class="nv">$2</span>
  st  <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$2</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  ld  <span class="nv">$3</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  mult  <span class="nv">$3</span>, <span class="nv">$2</span>
  mflo  <span class="nv">$2</span>
  mfhi  <span class="nv">$3</span>
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  st  <span class="nv">$3</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 56
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  _Z13test_longlongv
<span class="nv">$tmp1</span>:
  .size _Z13test_longlongv, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-_Z13test_longlongv
</pre></div>
</div>
</div>
<div class="section" id="float-and-double">
<h2>float and double<a class="headerlink" href="#float-and-double" title="Permalink to this headline">¶</a></h2>
<p>Cpu0 only has integer instructions at this point. For float operations, the clang
will call the library function to translate integer to float. This float (or
double) function call for Cpu0 will be supported after the chapter of function
call.</p>
</div>
<div class="section" id="array-and-struct-support">
<h2>Array and struct support<a class="headerlink" href="#array-and-struct-support" title="Permalink to this headline">¶</a></h2>
<p>LLVM use getelementptr to represent the array and struct type in C.
Please reference section getelementptr of <a class="footnote-reference" href="#id2" id="id1">[1]</a>.
For ch7_5.cpp, the llvm IR as follows,</p>
<p class="rubric">lbdex/InputFiles/ch7_5.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">year</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">month</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">day</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">test_struct</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">day</span><span class="p">);</span> <span class="c1">// 10+12=22</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>// ch7_5.ll
; <span class="nv">ModuleID</span> <span class="o">=</span> <span class="s1">&#39;ch7_5.bc&#39;</span>
...
%struct.Date <span class="o">=</span> <span class="nb">type</span> <span class="o">{</span> i32, i32, i32 <span class="o">}</span>

@date <span class="o">=</span> global %struct.Date <span class="o">{</span> i32 2012, i32 10, i32 12 <span class="o">}</span>, align 4
@a <span class="o">=</span> global <span class="o">[</span>3 x i32<span class="o">]</span> <span class="o">[</span>i32 2012, i32 10, i32 12<span class="o">]</span>, align 4

define i32 @main<span class="o">()</span> nounwind ssp <span class="o">{</span>
entry:
  %retval <span class="o">=</span> alloca i32, align 4
  %day <span class="o">=</span> alloca i32, align 4
  %i <span class="o">=</span> alloca i32, align 4
  store i32 0, i32* %retval
  %0 <span class="o">=</span> load i32* getelementptr inbounds <span class="o">(</span>%struct.Date* @date, i32 0, i32 2<span class="o">)</span>,
  align 4
  store i32 %0, i32* %day, align 4
  %1 <span class="o">=</span> load i32* getelementptr inbounds <span class="o">([</span>3 x i32<span class="o">]</span>* @a, i32 0, i32 1<span class="o">)</span>, align 4
  store i32 %1, i32* %i, align 4
  ret i32 0
<span class="o">}</span>
</pre></div>
</div>
<p>Run Chapter6_1/ with ch7_5.bc on static mode will get the incorrect asm file as
follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>1-160-134-62:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/bin/
Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm ch7_5.bc -o -
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch7_5.bc&quot;</span>
  .text
  .globl  _Z11test_structv
  .align  2
  .type _Z11test_structv,@function
  .ent  _Z11test_structv        <span class="c"># @_Z11test_structv</span>
_Z11test_structv:
  .frame  <span class="nv">$fp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
  lui <span class="nv">$2</span>, %hi<span class="o">(</span>date<span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$2</span>, %lo<span class="o">(</span>date<span class="o">)</span>
    ld  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>   // the correct one is   ld  <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lui <span class="nv">$2</span>, %hi<span class="o">(</span>a<span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$2</span>, %lo<span class="o">(</span>a<span class="o">)</span>
  ld  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
  st  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  _Z11test_structv
<span class="nv">$tmp1</span>:
  .size _Z11test_structv, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-_Z11test_structv

  .type date,@object            <span class="c"># @date</span>
  .data
  .globl  date
  .align  2
date:
  .4byte  2012                    <span class="c"># 0x7dc</span>
  .4byte  10                      <span class="c"># 0xa</span>
  .4byte  12                      <span class="c"># 0xc</span>
  .size date, 12

  .type a,@object               <span class="c"># @a</span>
  .globl  a
  .align  2
a:
  .4byte  2012                    <span class="c"># 0x7dc</span>
  .4byte  10                      <span class="c"># 0xa</span>
  .4byte  12                      <span class="c"># 0xc</span>
  .size a, 12
</pre></div>
</div>
<p>For <strong>“day = date.day”</strong>, the correct one is <strong>“ld $2, 8($2)”</strong>, not
<strong>“ld $2, 0($2)”</strong>, since date.day is offset 8(date) (
Type int is 4 bytes in Cpu0, and the date.day has fields year and month before
it).
Let use debug option in llc to see what&#8217;s wrong,</p>
<div class="highlight-bash"><div class="highlight"><pre>jonathantekiimac:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/
cmake_debug_build/bin/Debug/llc -march<span class="o">=</span>cpu0 -debug -relocation-model<span class="o">=</span>static
-filetype<span class="o">=</span>asm ch6_2.bc -o ch6_2.cpu0.static.s
...
<span class="o">===</span> main
Initial selection DAG: BB#0 <span class="s1">&#39;main:entry&#39;</span>
SelectionDAG has 20 nodes:
  0x7f7f5b02d210: <span class="nv">i32</span> <span class="o">=</span> undef <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5ac10590: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d010: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d110: <span class="nv">i32</span> <span class="o">=</span> FrameIndex&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d210: &lt;multiple use&gt;
    0x7f7f5b02d310: <span class="nv">ch</span> <span class="o">=</span> store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,
    0x7f7f5b02d210&lt;ST4<span class="o">[</span>%retval<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d410: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;%struct.Date* @date&gt; 0 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

      0x7f7f5b02d510: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;8&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

    0x7f7f5b02d610: <span class="nv">i32</span> <span class="o">=</span> add 0x7f7f5b02d410, 0x7f7f5b02d510 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

    0x7f7f5b02d210: &lt;multiple use&gt;
  0x7f7f5b02d710: i32,ch <span class="o">=</span> load 0x7f7f5b02d310, 0x7f7f5b02d610, 0x7f7f5b02d210
  &lt;LD4<span class="o">[</span>getelementptr inbounds <span class="o">(</span>%struct.Date* @date, i32 0, i32 2<span class="o">)]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>3<span class="o">]</span>

  0x7f7f5b02db10: <span class="nv">i64</span> <span class="o">=</span> Constant&lt;4&gt;

      0x7f7f5b02d710: &lt;multiple use&gt;
      0x7f7f5b02d710: &lt;multiple use&gt;
      0x7f7f5b02d810: <span class="nv">i32</span> <span class="o">=</span> FrameIndex&lt;1&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span>

      0x7f7f5b02d210: &lt;multiple use&gt;
    0x7f7f5b02d910: <span class="nv">ch</span> <span class="o">=</span> store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,
     0x7f7f5b02d210&lt;ST4<span class="o">[</span>%day<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span>

      0x7f7f5b02da10: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;<span class="o">[</span>3 x i32<span class="o">]</span>* @a&gt; 0 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>5<span class="o">]</span>

      0x7f7f5b02dc10: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;4&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>5<span class="o">]</span>

    0x7f7f5b02dd10: <span class="nv">i32</span> <span class="o">=</span> add 0x7f7f5b02da10, 0x7f7f5b02dc10 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>5<span class="o">]</span>

    0x7f7f5b02d210: &lt;multiple use&gt;
  0x7f7f5b02de10: i32,ch <span class="o">=</span> load 0x7f7f5b02d910, 0x7f7f5b02dd10, 0x7f7f5b02d210
  &lt;LD4<span class="o">[</span>getelementptr inbounds <span class="o">([</span>3 x i32<span class="o">]</span>* @a, i32 0, i32 1<span class="o">)]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>6<span class="o">]</span>

...


Replacing.3 0x7f7f5b02dd10: <span class="nv">i32</span> <span class="o">=</span> add 0x7f7f5b02da10, 0x7f7f5b02dc10 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>5<span class="o">]</span>

With: 0x7f7f5b030010: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;<span class="o">[</span>3 x i32<span class="o">]</span>* @a&gt; + 4


Replacing.3 0x7f7f5b02d610: <span class="nv">i32</span> <span class="o">=</span> add 0x7f7f5b02d410, 0x7f7f5b02d510 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

With: 0x7f7f5b02db10: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;%struct.Date* @date&gt; + 8

Optimized lowered selection DAG: BB#0 <span class="s1">&#39;main:entry&#39;</span>
SelectionDAG has 15 nodes:
  0x7f7f5b02d210: <span class="nv">i32</span> <span class="o">=</span> undef <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5ac10590: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d010: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d110: <span class="nv">i32</span> <span class="o">=</span> FrameIndex&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

      0x7f7f5b02d210: &lt;multiple use&gt;
    0x7f7f5b02d310: <span class="nv">ch</span> <span class="o">=</span> store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,
    0x7f7f5b02d210&lt;ST4<span class="o">[</span>%retval<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

    0x7f7f5b02db10: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;%struct.Date* @date&gt; + 8

    0x7f7f5b02d210: &lt;multiple use&gt;
  0x7f7f5b02d710: i32,ch <span class="o">=</span> load 0x7f7f5b02d310, 0x7f7f5b02db10, 0x7f7f5b02d210
  &lt;LD4<span class="o">[</span>getelementptr inbounds <span class="o">(</span>%struct.Date* @date, i32 0, i32 2<span class="o">)]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>3<span class="o">]</span>

      0x7f7f5b02d710: &lt;multiple use&gt;
      0x7f7f5b02d710: &lt;multiple use&gt;
      0x7f7f5b02d810: <span class="nv">i32</span> <span class="o">=</span> FrameIndex&lt;1&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span>

      0x7f7f5b02d210: &lt;multiple use&gt;
    0x7f7f5b02d910: <span class="nv">ch</span> <span class="o">=</span> store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,
     0x7f7f5b02d210&lt;ST4<span class="o">[</span>%day<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span>

    0x7f7f5b030010: <span class="nv">i32</span> <span class="o">=</span> GlobalAddress&lt;<span class="o">[</span>3 x i32<span class="o">]</span>* @a&gt; + 4

    0x7f7f5b02d210: &lt;multiple use&gt;
  0x7f7f5b02de10: i32,ch <span class="o">=</span> load 0x7f7f5b02d910, 0x7f7f5b030010, 0x7f7f5b02d210
  &lt;LD4<span class="o">[</span>getelementptr inbounds <span class="o">([</span>3 x i32<span class="o">]</span>* @a, i32 0, i32 1<span class="o">)]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>6<span class="o">]</span>

...
</pre></div>
</div>
<p>Through <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></tt>, you can see the DAG translation process.
As above, the DAG list
for date.day (add GlobalAddress&lt;[3 x i32]* &#64;a&gt; 0, Constant&lt;8&gt;) with 3 nodes is
replaced by 1 node GlobalAddress&lt;%struct.Date* &#64;date&gt; + 8.
The DAG list for a[1] is same.
The replacement occurs since TargetLowering.cpp::isOffsetFoldingLegal(...)
return true in <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-static</span></tt> static addressing mode as below.
In Cpu0 the <strong>ld</strong> instruction format is <strong>“ld $r1, offset($r2)”</strong> which
meaning load $r2 address+offset to $r1.
So, we just replace the isOffsetFoldingLegal(...) function by override
mechanism as below.</p>
<p class="rubric">lib/CodeGen/SelectionDAG/TargetLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">bool</span>
<span class="n">TargetLowering</span><span class="o">::</span><span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="k">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// Assume that everything is safe in static mode.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">==</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Static</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// In dynamic-no-pic mode, assume that known defined values are safe.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">==</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">DynamicNoPIC</span> <span class="o">&amp;&amp;</span>
     <span class="n">GA</span> <span class="o">&amp;&amp;</span>
     <span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isDeclaration</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
     <span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isWeakForLinker</span><span class="p">())</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// Otherwise assume nothing is safe.</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">bool</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="k">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// The Cpu0 target isn&#39;t yet aware of offsets.</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Beyond that, we need to add the following code fragment to Cpu0ISelDAGToDAG.cpp,</p>
<p class="rubric">lbdex/Chapter7_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//  Cpu0ISelDAGToDAG.cpp</span>
<span class="c1">/// ComplexPattern used on Cpu0InstrInfo</span>
<span class="c1">/// Used on Cpu0 Load/Store instructions</span>
<span class="kt">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="c1">// Addresses of the form FI+const or FI|const</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">isBaseWithConstantOffset</span><span class="p">(</span><span class="n">Addr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ConstantSDNode</span> <span class="o">*</span><span class="n">CN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Addr</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">()))</span> <span class="p">{</span>

      <span class="c1">// If the first operand is a FI, get the TargetFI Node</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">FrameIndexSDNode</span> <span class="o">*</span><span class="n">FIN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FrameIndexSDNode</span><span class="o">&gt;</span>
                                          <span class="p">(</span><span class="n">Addr</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetFrameIndex</span><span class="p">(</span><span class="n">FIN</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

      <span class="n">Offset</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">(),</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall we have translated DAG list for date.day
(add GlobalAddress&lt;[3 x i32]* &#64;a&gt; 0, Constant&lt;8&gt;) into
(add (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),
Constant&lt;8&gt;) by the following code in Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Cpu0ISelLowering.cpp</span>
<span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                    <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="c1">// %hi/%lo relocation</span>
    <span class="n">SDValue</span> <span class="n">GAHi</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_ABS_HI</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">GALo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_ABS_LO</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">HiPart</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VTs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GAHi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">GALo</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">HiPart</span><span class="p">,</span> <span class="n">Lo</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So, when the SelectAddr(...) of Cpu0ISelDAGToDAG.cpp is called.
The Addr SDValue in SelectAddr(..., Addr, ...) is DAG list for date.day
(add (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),
Constant&lt;8&gt;).
Since Addr.getOpcode() = ISD:ADD, Addr.getOperand(0) =
(add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)) and
Addr.getOperand(1).getOpcode() = ISD::Constant, the Base = SDValue
(add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)) and
Offset = Constant&lt;8&gt;.
After set Base and Offset, the load DAG will translate the global address
date.day into machine instruction <strong>“ld $r1, 8($r2)”</strong> in Instruction Selection
stage.</p>
<p>Chapter7_1/ include these changes as above, you can run it with ch7_5.cpp to get
the correct generated instruction <strong>“ld $r1, 8($r2)”</strong> for date.day access, as
follows.</p>
<div class="highlight-bash"><div class="highlight"><pre>...
ld  <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
st  <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, %hi<span class="o">(</span>a<span class="o">)</span>
shl <span class="nv">$2</span>, <span class="nv">$2</span>, 16
addiu <span class="nv">$2</span>, <span class="nv">$2</span>, %lo<span class="o">(</span>a<span class="o">)</span>
ld  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
</pre></div>
</div>
<p>The ch7_5_2.cpp is for local variable initialization test. The result as
follows,</p>
<p class="rubric">lbdex/InputFiles/ch7_5_2.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
    
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-79-206:InputFiles Jonathan<span class="nv">$ </span>llvm-dis ch7_5_2.bc -o -
...
define i32 @main<span class="o">()</span> nounwind ssp <span class="o">{</span>
entry:
  %retval <span class="o">=</span> alloca i32, align 4
  %a <span class="o">=</span> alloca <span class="o">[</span>3 x i32<span class="o">]</span>, align 4
  store i32 0, i32* %retval
  %0 <span class="o">=</span> bitcast <span class="o">[</span>3 x i32<span class="o">]</span>* %a to i8*
  call void @llvm.memcpy.p0i8.p0i8.i32<span class="o">(</span>i8* %0, i8* bitcast <span class="o">([</span>3 x i32<span class="o">]</span>*
    @_ZZ4mainE1a to i8*<span class="o">)</span>, i32 12, i32 4, i1 <span class="nb">false</span><span class="o">)</span>
  ret i32 0
<span class="o">}</span>
; Function Attrs: nounwind
<span class="nb">declare </span>void @llvm.memcpy.p0i8.p0i8.i32<span class="o">(</span>i8* nocapture, i8* nocapture, i32, i32, i1<span class="o">)</span> <span class="c">#1</span>

118-165-79-206:InputFiles Jonathan<span class="nv">$ </span>/usr/local/llvm/test/cmake_debug_build/
bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch7_5_2.bc -o -
        .section .mdebug.abi32
        .previous
        .file <span class="s2">&quot;ch7_5_2.bc&quot;</span>
        .text
        .globl        main
        .align        2
        .type main,@function
        .ent  main                    <span class="c"># @main</span>
main:
        .frame        <span class="nv">$fp</span>,16,<span class="nv">$lr</span>
        .mask         0x00000000,0
        .set  noreorder
        .cpload       <span class="nv">$t9</span>
        .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -16
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
        st    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$2</span>, %got<span class="o">(</span><span class="nv">$_ZZ4mainE1a</span><span class="o">)(</span><span class="nv">$gp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, %lo<span class="o">(</span><span class="nv">$_ZZ4mainE1a</span><span class="o">)</span>
        ld    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
        st    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
        st    <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$2</span><span class="o">)</span>
        st    <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 16
        ret   <span class="nv">$lr</span>
        .set  macro
        .set  reorder
        .end  main
<span class="nv">$tmp1</span>:
        .size main, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-main

        .type <span class="nv">$_ZZ4mainE1a</span>,@object    <span class="c"># @_ZZ4mainE1a</span>
        .section      .rodata,<span class="s2">&quot;a&quot;</span>,@progbits
        .align        2
<span class="nv">$_ZZ4mainE1a</span>:
        .4byte        0                       <span class="c"># 0x0</span>
        .4byte        1                       <span class="c"># 0x1</span>
        .4byte        2                       <span class="c"># 0x2</span>
        .size <span class="nv">$_ZZ4mainE1a</span>, 12
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html">http://llvm.org/docs/LangRef.html</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>