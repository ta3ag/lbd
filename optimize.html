<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Backend Optimization &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="LLD for Cpu0" href="lld.html" />
    <link rel="prev" title="Run backend" href="runbackend.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Backend Optimization</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="runbackend.html">Run backend</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="lld.html">LLD for Cpu0</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="backend-optimization">
<span id="sec-optimize"></span><h1>Backend Optimization<a class="headerlink" href="#backend-optimization" title="Permalink to this headline">¶</a></h1>
<p>This chapter introduce how to do backend optimization in LLVM first.
Next we do optimization via extend instruction sets with hardware level to
do optimization in a way of creating an efficient RISC CPU which aims to C/C++
high level language.</p>
<div class="section" id="cpu0-backend-optimization-remove-useless-jmp">
<h2>Cpu0 backend Optimization: Remove useless JMP<a class="headerlink" href="#cpu0-backend-optimization-remove-useless-jmp" title="Permalink to this headline">¶</a></h2>
<p>LLVM uses functional pass in code generation and optimization.
Following the 3 tiers of compiler architecture, LLVM did much optimization in
middle tier of LLVM IR, SSA form.
In addition of this middle tier optimization, there are opportunities in
optimization which depend on backend features.
Mips fill delay slot is an example of backend optimization used in pipeline
RISC machine.
You can modify from Mips this part if your backend is a pipeline RISC with
delay slot. In this section,
we apply the &#8220;delete useless jmp&#8221; unconditional branch instruction in Cpu0
backend optimization.
This algorithm is simple and effective as a perfect tutorial in optimization.
Through this example, you can understand how to add a optimization pass and
design your complicate optimization algorithm on your backend in real project.</p>
<p>Chapter12_1/ supports &#8220;delete useless jmp&#8221; optimization algorithm which add
codes as follows,</p>
<p class="rubric">lbdex/Chapter12_1/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
  <span class="p">...</span>
  <span class="n">Cpu0DelUselessJMP</span><span class="p">.</span><span class="n">cpp</span>
  <span class="p">...</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_1/Cpu0.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">...</span>
  <span class="n">FunctionPass</span> <span class="o">*</span><span class="n">createCpu0DelJmpPass</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_1/Cpu0TargetMachine.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">addPreEmitPass</span><span class="p">();</span>
<span class="p">};</span>
<span class="p">...</span>
<span class="c1">// Implemented by targets that want to run passes immediately before</span>
<span class="c1">// machine code is emitted. return true if -print-machineinstrs should</span>
<span class="c1">// print out the code after the passes.</span>
<span class="kt">bool</span> <span class="n">Cpu0PassConfig</span><span class="o">::</span><span class="n">addPreEmitPass</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span> <span class="o">=</span> <span class="n">getCpu0TargetMachine</span><span class="p">();</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createCpu0DelJmpPass</span><span class="p">(</span><span class="n">TM</span><span class="p">));</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_1/Cpu0DelUselessJMP.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0DelUselessJMP.cpp - Cpu0 DelJmp -------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Simple pass to fills delay slots with useful instructions.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#define DEBUG_TYPE &quot;del-jmp&quot;</span>

<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunctionPass.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetInstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/SmallSet.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/Statistic.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">STATISTIC</span><span class="p">(</span><span class="n">NumDelJmp</span><span class="p">,</span> <span class="s">&quot;Number of useless jmp deleted&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">EnableDelJmp</span><span class="p">(</span>
  <span class="s">&quot;enable-cpu0-del-useless-jmp&quot;</span><span class="p">,</span>
  <span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
  <span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Delete useless jmp instructions: jmp 0.&quot;</span><span class="p">),</span>
  <span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">);</span>

<span class="k">namespace</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">DelJmp</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionPass</span> <span class="p">{</span>

    <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span><span class="p">;</span>

    <span class="k">static</span> <span class="kt">char</span> <span class="n">ID</span><span class="p">;</span>
    <span class="n">DelJmp</span><span class="p">(</span><span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">MachineFunctionPass</span><span class="p">(</span><span class="n">ID</span><span class="p">),</span> <span class="n">TM</span><span class="p">(</span><span class="n">tm</span><span class="p">),</span> <span class="n">TII</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">())</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getPassName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s">&quot;Cpu0 Del Useless jmp&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">runOnMachineBasicBlock</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBBN</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">bool</span> <span class="n">Changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">EnableDelJmp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">FJ</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">FJ</span> <span class="o">!=</span> <span class="n">F</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
          <span class="n">FJ</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">FJ</span> <span class="o">==</span> <span class="n">F</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
          <span class="k">return</span> <span class="n">Changed</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">FI</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">FE</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
             <span class="n">FJ</span> <span class="o">!=</span> <span class="n">FE</span><span class="p">;</span> <span class="o">++</span><span class="n">FI</span><span class="p">,</span> <span class="o">++</span><span class="n">FJ</span><span class="p">)</span>
          <span class="c1">// In STL style, F.end() is the dummy BasicBlock() like &#39;\0&#39; in </span>
          <span class="c1">//  C string. </span>
          <span class="c1">// FJ is the next BasicBlock of FI; When FI range from F.begin() to </span>
          <span class="c1">//  the PreviousBasicBlock of F.end() call runOnMachineBasicBlock().</span>
          <span class="n">Changed</span> <span class="o">|=</span> <span class="n">runOnMachineBasicBlock</span><span class="p">(</span><span class="o">*</span><span class="n">FI</span><span class="p">,</span> <span class="o">*</span><span class="n">FJ</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">Changed</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>
  <span class="kt">char</span> <span class="n">DelJmp</span><span class="o">::</span><span class="n">ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// end of anonymous namespace</span>

<span class="kt">bool</span> <span class="n">DelJmp</span><span class="o">::</span>
<span class="n">runOnMachineBasicBlock</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBBN</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">Changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span> <span class="o">=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span>
    <span class="n">I</span><span class="o">--</span><span class="p">;</span>	<span class="c1">// set I to the last instruction</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">Changed</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">JMP</span> <span class="o">&amp;&amp;</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getMBB</span><span class="p">()</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">MBBN</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// I is the instruction of &quot;jmp #offset=0&quot;, as follows,</span>
    <span class="c1">//     jmp	$BB0_3</span>
    <span class="c1">// $BB0_3:</span>
    <span class="c1">//     ld	$4, 28($sp)</span>
    <span class="o">++</span><span class="n">NumDelJmp</span><span class="p">;</span>
    <span class="n">MBB</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">I</span><span class="p">);</span>	<span class="c1">// delete the &quot;JMP 0&quot; instruction</span>
    <span class="n">Changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="c1">// Notify LLVM kernel Changed</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Changed</span><span class="p">;</span>

<span class="p">}</span>

<span class="c1">/// createCpu0DelJmpPass - Returns a pass that DelJmp in Cpu0 MachineFunctions</span>
<span class="n">FunctionPass</span> <span class="o">*</span><span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0DelJmpPass</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">DelJmp</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As above code, except Cpu0DelUselessJMP.cpp, other files changed for register
class DelJmp as a functional pass.
As the comment of above code, MBB is the current
block and MBBN is the next block. For the last instruction of every MBB, we
check if it is the JMP instruction as well as
its Operand is the next basic block.
By getMBB() in MachineOperand, you can get the MBB address.
For the member functions of MachineOperand, please check
include/llvm/CodeGen/MachineOperand.h
Let&#8217;s run Chapter12_1/ with ch12_1.cpp for explanation.</p>
<p class="rubric">lbdex/InputFiles/ch12_1.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">c</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-10:InputFiles Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu
-c ch12_1.cpp -emit-llvm -o ch12_1.bc
118-165-78-10:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm -stats
ch12_1.bc -o -

        .section .mdebug.abi32
        .previous
        .file <span class="s2">&quot;ch12_1.bc&quot;</span>
        .text
        .globl        main
        .align        2
        .type main,@function
        .ent  main                    <span class="c"># @main</span>
main:
        .frame        <span class="nv">$fp</span>,24,<span class="nv">$lr</span>
        .mask         0x00001000,-4
        .set  noreorder
        .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -24
        st    <span class="nv">$fp</span>, 20<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Spill</span>
        addu  <span class="nv">$fp</span>, <span class="nv">$sp</span>, <span class="nv">$zero</span>
        addiu <span class="nv">$3</span>, <span class="nv">$zero</span>, 0
        st    <span class="nv">$3</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        st    <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 1
        st    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 2
        st    <span class="nv">$4</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        cmp   <span class="nv">$sw</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
        jne   <span class="nv">$sw</span>, <span class="nv">$BB0_2</span>
<span class="c"># BB#1:                                 # %if.then</span>
        ld    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_2</span>:                                 <span class="c"># %if.end</span>
        ld    <span class="nv">$4</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        cmp   <span class="nv">$sw</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
        jne   <span class="nv">$sw</span>, <span class="nv">$BB0_4</span>
        jmp   <span class="nv">$BB0_3</span>
<span class="nv">$BB0_4</span>:                                 <span class="c"># %if.else</span>
        addiu <span class="nv">$3</span>, <span class="nv">$zero</span>, -1
        ld    <span class="nv">$4</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        cmp   <span class="nv">$sw</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
        jgt   <span class="nv">$sw</span>, <span class="nv">$BB0_6</span>
        jmp   <span class="nv">$BB0_5</span>
<span class="nv">$BB0_3</span>:                                 <span class="c"># %if.then2</span>
        ld    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$3</span>, <span class="nv">$4</span>, <span class="nv">$3</span>
        st    <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        jmp   <span class="nv">$BB0_6</span>
<span class="nv">$BB0_5</span>:                                 <span class="c"># %if.then4</span>
        ld    <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$3</span>, -1
        st    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        st    <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_6</span>:                                 <span class="c"># %if.end6</span>
        ld    <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        cmp   <span class="nv">$sw</span>, <span class="nv">$3</span>, <span class="nv">$2</span>
        jlt   <span class="nv">$sw</span>, <span class="nv">$BB0_8</span>
<span class="c"># BB#7:                                 # %if.then8</span>
        ld    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_8</span>:                                 <span class="c"># %if.end10</span>
        ld    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$sp</span>, <span class="nv">$fp</span>, <span class="nv">$zero</span>
        ld    <span class="nv">$fp</span>, 20<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Reload</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 24
        ret   <span class="nv">$lr</span>
        .set  macro
        .set  reorder
        .end  main
<span class="nv">$tmp3</span>:
        .size main, <span class="o">(</span><span class="nv">$tmp3</span><span class="o">)</span>-main
...
<span class="o">===</span>-------------------------------------------------------------------------<span class="o">===</span>
                          ... Statistics Collected ...
<span class="o">===</span>-------------------------------------------------------------------------<span class="o">===</span>
 ...
 2 del-jmp        - Number of useless jmp deleted
 ...
</pre></div>
</div>
<p>The terminal display &#8220;Number of useless jmp deleted&#8221; by <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-stats</span></tt> option
because we set the &#8220;STATISTIC(NumDelJmp, &#8220;Number of useless jmp deleted&#8221;)&#8221; in
code. It deletes 2 jmp instructions from block &#8220;# BB#0&#8221; and &#8220;$BB0_6&#8221;.
You can check it by <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-enable-cpu0-del-useless-jmp=false</span></tt> option to see
the difference to no optimization version.
If you run with ch8_1_1.cpp, will find 10 jmp instructions are deleted in 100
lines of assembly code, which meaning 10% improvement in speed and code size.</p>
</div>
<div class="section" id="cpu0-optimization-extends-instruction-sets">
<h2>Cpu0 Optimization: Extends instruction sets<a class="headerlink" href="#cpu0-optimization-extends-instruction-sets" title="Permalink to this headline">¶</a></h2>
<p>If you compare the cpu0 and Mips instruction sets, you will find that Mips use
SLT, BEQ and set the status in explicit/general register while Cpu0 use CMP,
JEQ and set status in implicit/specific register.</p>
<p>According RISC spirits, this section will replace CMP, JEQ with Mips style
instructions.
Mips style BEQ instructions will reduce the number of branch instructions too.
Which means optimization in speed and code size.</p>
<div class="section" id="cpu0-new-instruction-sets-table">
<h3>Cpu0 new instruction sets table<a class="headerlink" href="#cpu0-new-instruction-sets-table" title="Permalink to this headline">¶</a></h3>
<p>Add Cpu0 instructions as follows,</p>
<ul class="simple">
<li>First column F.: meaning Format.</li>
</ul>
<table border="1" class="docutils">
<caption>Cpu0 Instruction Set
      :widths: 1 4 3 11 7 10
      :header-rows: 1</caption>
<colgroup>
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>F.</td>
<td>Mnemonic</td>
<td>Opcode</td>
<td>Meaning</td>
<td>Syntax</td>
<td>Operation</td>
</tr>
<tr class="row-even"><td>L</td>
<td>SLTi</td>
<td>26</td>
<td>Set less Then</td>
<td>SLTi Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb &lt; Cx)</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>SLTiu</td>
<td>27</td>
<td>SLTi unsigned</td>
<td>SLTiu Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb &lt; Cx)</td>
</tr>
<tr class="row-even"><td>A</td>
<td>SLT</td>
<td>28</td>
<td>Set less Then</td>
<td>SLT Ra, Rb, Rc</td>
<td>Ra &lt;= (Rb &lt; Rc)</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>SLTu</td>
<td>29</td>
<td>SLT unsigned</td>
<td>SLTu Ra, Rb, Rc</td>
<td>Ra &lt;= (Rb &lt; Rc)</td>
</tr>
<tr class="row-even"><td>L</td>
<td>BEQ</td>
<td>37</td>
<td>Jump if equal</td>
<td>BEQ Ra, Rb, Cx</td>
<td>if (Ra==Rb), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>BNE</td>
<td>38</td>
<td>Jump if not equal</td>
<td>BNE Ra, Rb, Cx</td>
<td>if (Ra!=Rb), PC &lt;= PC + Cx</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cpu0-code-changes">
<h3>Cpu0 code changes<a class="headerlink" href="#cpu0-code-changes" title="Permalink to this headline">¶</a></h3>
<p>Chapter12_2/ include the changes for new instruction sets as follows,</p>
<p class="rubric">lbdex/Chapter12_2/Disassembler/Cpu0Disassembler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="n">DecodeStatus</span> <span class="nf">DecodeBranch16Target</span><span class="p">(</span><span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span>
                                       <span class="kt">unsigned</span> <span class="n">Insn</span><span class="p">,</span>
                                       <span class="kt">uint64_t</span> <span class="n">Address</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">Decoder</span><span class="p">);</span>
<span class="p">...</span>
<span class="k">static</span> <span class="n">DecodeStatus</span> <span class="n">DecodeBranch16Target</span><span class="p">(</span><span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span>
                                       <span class="kt">unsigned</span> <span class="n">Insn</span><span class="p">,</span>
                                       <span class="kt">uint64_t</span> <span class="n">Address</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">Decoder</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">BranchOffset</span> <span class="o">=</span> <span class="n">fieldFromInstruction</span><span class="p">(</span><span class="n">Insn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">BranchOffset</span> <span class="o">&gt;</span> <span class="mh">0x8fff</span><span class="p">)</span>
    <span class="n">BranchOffset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="mh">0x10000</span> <span class="o">-</span> <span class="n">BranchOffset</span><span class="p">);</span>
  <span class="n">Inst</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">MCOperand</span><span class="o">::</span><span class="n">CreateImm</span><span class="p">(</span><span class="n">BranchOffset</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">MCDisassembler</span><span class="o">::</span><span class="n">Success</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/MCTargetDesc/Cpu0AsmBackend.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">adjustFixupValue</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Kind</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Add/subtract and shift</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">fixup_Cpu0_PC16</span><span class="o">:</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">fixup_Cpu0_PC24</span><span class="o">:</span>
    <span class="c1">// So far we are only using this type for branches.</span>
    <span class="c1">// For branches we start 1 instruction after the branch</span>
    <span class="c1">// so the displacement will be one instruction size less.</span>
    <span class="n">Value</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
  <span class="k">const</span> <span class="n">MCFixupKindInfo</span> <span class="o">&amp;</span><span class="n">getFixupKindInfo</span><span class="p">(</span><span class="n">MCFixupKind</span> <span class="n">Kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">const</span> <span class="k">static</span> <span class="n">MCFixupKindInfo</span> <span class="n">Infos</span><span class="p">[</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">NumTargetFixupKinds</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1">// This table *must* be in same the order of fixup_* kinds in</span>
      <span class="c1">// Cpu0FixupKinds.h.</span>
      <span class="c1">//</span>
      <span class="c1">// name                    offset  bits  flags</span>
      <span class="p">...</span>
      <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_PC16&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>  <span class="n">MCFixupKindInfo</span><span class="o">::</span><span class="n">FKF_IsPCRel</span> <span class="p">},</span>
<span class="p">...</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/MCTargetDesc/Cpu0ELFObjectWriter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="n">Cpu0ELFObjectWriter</span><span class="o">::</span><span class="n">GetRelocType</span><span class="p">(</span><span class="k">const</span> <span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Target</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">MCFixup</span> <span class="o">&amp;</span><span class="n">Fixup</span><span class="p">,</span>
                                           <span class="kt">bool</span> <span class="n">IsPCRel</span><span class="p">,</span>
                                           <span class="kt">bool</span> <span class="n">IsRelocWithSymbol</span><span class="p">,</span>
                                           <span class="kt">int64_t</span> <span class="n">Addend</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">fixup_Cpu0_PC16</span><span class="o">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_PC16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/MCTargetDesc/Cpu0FixupKinds.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">enum</span> <span class="n">Fixups</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// PC relative branch fixup resulting in - R_CPU0_PC16.</span>
  <span class="c1">// cpu0 PC16, e.g. beq</span>
  <span class="n">fixup_Cpu0_PC16</span><span class="p">,</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/MCTargetDesc/Cpu0MCCodeEmitter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">// getBranch16TargetOpValue - Return binary encoding of the branch</span>
  <span class="c1">// target operand, such as BEQ, BNE. If the machine operand</span>
  <span class="c1">// requires relocation, record the relocation and return zero.</span>
  <span class="kt">unsigned</span> <span class="n">getBranch16TargetOpValue</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                                  <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

<span class="p">...</span>
<span class="c1">/// getBranch16TargetOpValue - Return binary encoding of the branch</span>
<span class="c1">/// target operand. If the machine operand requires relocation,</span>
<span class="c1">/// record the relocation and return zero.</span>
<span class="kt">unsigned</span> <span class="n">Cpu0MCCodeEmitter</span><span class="o">::</span>
<span class="n">getBranch16TargetOpValue</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                       <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>

  <span class="k">const</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">MO</span> <span class="o">=</span> <span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">OpNo</span><span class="p">);</span>

  <span class="c1">// If the destination is an immediate, we have nothing to do.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">isImm</span><span class="p">())</span> <span class="k">return</span> <span class="n">MO</span><span class="p">.</span><span class="n">getImm</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">isExpr</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;getBranch16TargetOpValue expects only expressions&quot;</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">MO</span><span class="p">.</span><span class="n">getExpr</span><span class="p">();</span>
  <span class="n">Fixups</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">MCFixup</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span>
                                   <span class="n">MCFixupKind</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_PC16</span><span class="p">)));</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// lbd document - mark - getBranch16TargetOpValue</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/MCTargetDesc/Cpu0TargetDesc.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ParseCpu0Triple</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">TheTriple</span> <span class="o">==</span> <span class="s">&quot;cpu0&quot;</span> <span class="o">||</span> <span class="n">TheTriple</span> <span class="o">==</span> <span class="s">&quot;cpu0el&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">==</span> <span class="s">&quot;cpu032II&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Cpu0ArchFeature</span> <span class="o">=</span> <span class="s">&quot;+cpu032II&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Cpu0ArchFeature</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 Subtarget features                                                    //</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="p">...</span>
<span class="n">def</span> <span class="n">FeatureCpu032II</span>    <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span>
         <span class="s">&quot;Cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032II ISA Support (use instruction slt)&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">FeatureCpu032III</span>   <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032III&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span>
         <span class="s">&quot;Cpu032III&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032III ISA Support (use instruction slt)&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 processors supported.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="p">...</span>
<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">FeatureCpu032II</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032III&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">FeatureCpu032III</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/Cpu0InstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Cpu0InstrInfo::copyPhysReg()</span>
<span class="kt">void</span> <span class="n">Cpu0InstrInfo</span><span class="o">::</span>
<span class="n">copyPhysReg</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
            <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span> <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">,</span>
            <span class="kt">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span>
            <span class="kt">bool</span> <span class="n">KillSrc</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span> <span class="o">=</span> <span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">DestReg</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// Copy to CPU Reg.</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">hasCpu032II</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SrcReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SW</span><span class="p">)</span>
        <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">MFSW</span><span class="p">,</span> <span class="n">SrcReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// lbd document - mark - if (!Subtarget.hasCpu032II()) 1</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// Copy from CPU Reg.</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">hasCpu032II</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// lbd document - mark - 2</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DestReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SW</span><span class="p">)</span>
        <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">MTSW</span><span class="p">,</span> <span class="n">DestReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="c1">// lbd document - mark - if (!Subtarget.hasCpu032II()) 2</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>def NotCpu032II :     Predicate&lt;"!Subtarget.hasCpu032II()"&gt;,
                      AssemblerPredicate&lt;"FeatureCpu032I"&gt;;
def HasCpu032II :     Predicate&lt;"Subtarget.hasCpu032II()"&gt;,
                      AssemblerPredicate&lt;"!FeatureCpu032III"&gt;;
// !FeatureCpu032III is for disassembler in "llvm-objdump -d"

/* In Cpu0GenSubtargetInfo.inc,
namespace llvm {
namespace Cpu0 {
enum {
  FeatureCpu032I =  1ULL &lt;&lt; 0,
  FeatureCpu032II =  1ULL &lt;&lt; 1,
  FeatureCpu032III =  1ULL &lt;&lt; 2
};
}
} // End llvm namespace

static bool checkDecoderPredicate(unsigned Idx, uint64_t Bits) {
  switch (Idx) {
  default: llvm_unreachable("Invalid index!");
  case 0:
    return ((Bits &amp; Cpu0::FeatureCpu032I)); // came from "FeatureCpu032I"
  case 1:
    return (!(Bits &amp; Cpu0::FeatureCpu032III)); // came from !FeatureCpu032III"
  }
}

To let disassembler work, the function
checkDecoderPredicate(unsigned Idx, uint64_t Bits) must return true(=1).
As above code, the argument Bits always is 1. Set !FeatureCpu032III" to do
disassembler for expectation. */
...
// BEQ, BNE
def brtarget16    : Operand&lt;OtherVT&gt; {
  let EncoderMethod = "getBranch16TargetOpValue";
  let OperandType = "OPERAND_PCREL";
  let DecoderMethod = "DecodeBranch16Target";
}
...
class ArithOverflowR&lt;bits&lt;8&gt; op, string instr_asm,
                    InstrItinClass itin, RegisterClass RC, bit isComm = 0&gt;:
  FA&lt;op, (outs RC:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, "\t$ra, $rb, $rc"), [], itin&gt; {
  let shamt = 0;
  let isCommutable = isComm;
}
class CmpInstr&lt;bits&lt;8&gt; op, string instr_asm,
               InstrItinClass itin, RegisterClass RC, RegisterClass RD,
               bit isComm = 0&gt;:
  ...
  let Predicates = [NotCpu032II];
}
// Conditional Branch, e.g. JEQ brtarget24
class CBranch24&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC,
                   list&lt;Register&gt; UseRegs&gt;:
  FJ&lt;op, (outs), (ins RC:$ra, brtarget24:$addr),
             !strconcat(instr_asm, "\t$ra, $addr"),
             [], IIBranch&gt;, Requires&lt;[NotCpu032II]&gt; {
  ...
//  let Predicates = [HasCpu032II]; // same effect as Requires
}

// Conditional Branch, e.g. BEQ $r1, $r2, brtarget16
class CBranch16&lt;bits&lt;8&gt; op, string instr_asm, PatFrag cond_op, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra, RC:$rb, brtarget16:$imm16),
             !strconcat(instr_asm, "\t$ra, $rb, $imm16"),
             [(brcond (i32 (cond_op RC:$ra, RC:$rb)), bb:$imm16)], IIBranch&gt;,
             Requires&lt;[HasCpu032II]&gt; {
  let isBranch = 1;
  let isTerminator = 1;
  let hasDelaySlot = 1;
  let Defs = [AT];
}

// SetCC
class SetCC_R&lt;bits&lt;8&gt; op, string instr_asm, PatFrag cond_op,
              RegisterClass RC&gt;:
  FA&lt;op, (outs CPURegs:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, "\t$ra, $rb, $rc"),
     [(set CPURegs:$ra, (cond_op RC:$rb, RC:$rc))],
     IIAlu&gt;, Requires&lt;[HasCpu032II]&gt; {
  let shamt = 0;
}

class SetCC_I&lt;bits&lt;8&gt; op, string instr_asm, PatFrag cond_op, Operand Od,
              PatLeaf imm_type, RegisterClass RC&gt;:
  FL&lt;op, (outs CPURegs:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, "\t$ra, $rb, $imm16"),
     [(set CPURegs:$ra, (cond_op RC:$rb, imm_type:$imm16))],
     IIAlu&gt;, Requires&lt;[HasCpu032II]&gt; {
}
...
def SLTi    : SetCC_I&lt;0x26, "slti", setlt, simm16, immSExt16, CPURegs&gt;;
def SLTiu   : SetCC_I&lt;0x27, "sltiu", setult, simm16, immSExt16, CPURegs&gt;;
def SLT     : SetCC_R&lt;0x28, "slt", setlt, CPURegs&gt;;
def SLTu    : SetCC_R&lt;0x29, "sltu", setult, CPURegs&gt;;
...
/// Jump and Branch Instructions
def BEQ     : CBranch&lt;0x37, "beq", seteq, CPURegs&gt;;
def BNE     : CBranch&lt;0x38, "bne", setne, CPURegs&gt;;
...
// brcond for slt instruction
multiclass BrcondPatsSlt&lt;RegisterClass RC, Instruction BEQOp, Instruction BNEOp,
                      Instruction SLTOp, Instruction SLTuOp, Instruction SLTiOp,
                      Instruction SLTiuOp, Register ZEROReg&gt; {
def : Pat&lt;(brcond (i32 (setne RC:$lhs, 0)), bb:$dst),
              (BNEOp RC:$lhs, ZEROReg, bb:$dst)&gt;;
def : Pat&lt;(brcond (i32 (seteq RC:$lhs, 0)), bb:$dst),
              (BEQOp RC:$lhs, ZEROReg, bb:$dst)&gt;;

def : Pat&lt;(brcond (i32 (setge RC:$lhs, RC:$rhs)), bb:$dst),
              (BEQ (SLTOp RC:$lhs, RC:$rhs), ZERO, bb:$dst)&gt;;
def : Pat&lt;(brcond (i32 (setuge RC:$lhs, RC:$rhs)), bb:$dst),
              (BEQ (SLTuOp RC:$lhs, RC:$rhs), ZERO, bb:$dst)&gt;;
def : Pat&lt;(brcond (i32 (setge RC:$lhs, immSExt16:$rhs)), bb:$dst),
              (BEQ (SLTiOp RC:$lhs, immSExt16:$rhs), ZERO, bb:$dst)&gt;;
def : Pat&lt;(brcond (i32 (setuge RC:$lhs, immSExt16:$rhs)), bb:$dst),
              (BEQ (SLTiuOp RC:$lhs, immSExt16:$rhs), ZERO, bb:$dst)&gt;;

def : Pat&lt;(brcond (i32 (setle RC:$lhs, RC:$rhs)), bb:$dst),
              (BEQ (SLTOp RC:$rhs, RC:$lhs), ZERO, bb:$dst)&gt;;
def : Pat&lt;(brcond (i32 (setule RC:$lhs, RC:$rhs)), bb:$dst),
              (BEQ (SLTuOp RC:$rhs, RC:$lhs), ZERO, bb:$dst)&gt;;

def : Pat&lt;(brcond RC:$cond, bb:$dst),
              (BNEOp RC:$cond, ZEROReg, bb:$dst)&gt;;
}

let Predicates = [NotCpu032II] in {
defm : BrcondPatsCmp&lt;CPURegs, JEQ, JNE, JLT, JGT, JLE, JGE, CMP, ZERO&gt;;
}

let Predicates = [HasCpu032II] in {
defm : BrcondPatsSlt&lt;CPURegs, BEQ, BNE, SLT, SLTu, SLTi, SLTiu, ZERO&gt;;
}
// setcc for slt instruction
multiclass SeteqPatsSlt&lt;RegisterClass RC, Instruction SLTiuOp, Instruction XOROp,
                     Instruction SLTuOp, Register ZEROReg&gt; {
// a == b
  def : Pat&lt;(seteq RC:$lhs, RC:$rhs),
                (SLTiuOp (XOROp RC:$lhs, RC:$rhs), 1)&gt;;
// a != b
  def : Pat&lt;(setne RC:$lhs, RC:$rhs),
                (SLTuOp ZEROReg, (XOROp RC:$lhs, RC:$rhs))&gt;;
}

// a &lt;= b
multiclass SetlePatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setle RC:$lhs, RC:$rhs),
// a &lt;= b is equal to (XORi (b &lt; a), 1)
                (XORi (SLTOp RC:$rhs, RC:$lhs), 1)&gt;;
  def : Pat&lt;(setule RC:$lhs, RC:$rhs),
                (XORi (SLTuOp RC:$rhs, RC:$lhs), 1)&gt;;
}

// a &gt; b
multiclass SetgtPatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setgt RC:$lhs, RC:$rhs),
// a &gt; b is equal to b &lt; a is equal to setlt(b, a)
                (SLTOp RC:$rhs, RC:$lhs)&gt;;
  def : Pat&lt;(setugt RC:$lhs, RC:$rhs),
                (SLTuOp RC:$rhs, RC:$lhs)&gt;;
}

// a &gt;= b
multiclass SetgePatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setge RC:$lhs, RC:$rhs),
// a &gt;= b is equal to b &lt;= a
                (XORi (SLTOp RC:$lhs, RC:$rhs), 1)&gt;;
  def : Pat&lt;(setuge RC:$lhs, RC:$rhs),
                (XORi (SLTuOp RC:$lhs, RC:$rhs), 1)&gt;;
}

multiclass SetgeImmPatsSlt&lt;RegisterClass RC, Instruction SLTiOp,
                        Instruction SLTiuOp&gt; {
  def : Pat&lt;(setge RC:$lhs, immSExt16:$rhs),
                (XORi (SLTiOp RC:$lhs, immSExt16:$rhs), 1)&gt;;
  def : Pat&lt;(setuge RC:$lhs, immSExt16:$rhs),
                (XORi (SLTiuOp RC:$lhs, immSExt16:$rhs), 1)&gt;;
}

let Predicates = [NotCpu032II] in {
defm : SeteqPatsCmp&lt;CPURegs&gt;;
defm : SetltPatsCmp&lt;CPURegs&gt;;
defm : SetlePatsCmp&lt;CPURegs&gt;;
defm : SetgtPatsCmp&lt;CPURegs&gt;;
defm : SetgePatsCmp&lt;CPURegs&gt;;
}

let Predicates = [HasCpu032II] in {
defm : SeteqPatsSlt&lt;CPURegs, SLTiu, XOR, SLTu, ZERO&gt;;
defm : SetlePatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgtPatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgePatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgeImmPatsSlt&lt;CPURegs, SLTi, SLTiu&gt;;
}</pre>
</div>
<p class="rubric">lbdex/Chapter12_2/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Select instructions not customized! Used for</span>
<span class="c1">/// expanded, promoted and normal instructions</span>
<span class="n">SDNode</span><span class="o">*</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span><span class="n">Select</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">SUBE</span><span class="o">:</span>
  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">ADDE</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span> <span class="o">=</span> <span class="n">getTargetMachine</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span> <span class="o">=</span> <span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">Carry</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">hasCpu032II</span><span class="p">())</span>
      <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SLTu</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">SDNode</span> <span class="o">*</span><span class="n">StatusWord</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CMP</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Constant1</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">VT</span><span class="p">);</span>
      <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span>
                                             <span class="n">SDValue</span><span class="p">(</span><span class="n">StatusWord</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Constant1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Chapter12_2/Cpu0Subtarget.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0Subtarget</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenSubtargetInfo</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">enum</span> <span class="n">Cpu0ArchEnum</span> <span class="p">{</span>
    <span class="n">Cpu032I</span>
    <span class="p">,</span> <span class="n">Cpu032II</span><span class="p">,</span>
    <span class="n">Cpu032III</span>
  <span class="p">};</span>
  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">hasCpu032I</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">&gt;=</span> <span class="n">Cpu032I</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCpu032II</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">==</span> <span class="n">Cpu032II</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As modified as listed above, the Chapter12_1 instructions are work for cpu032I
and the added instructions in Chapter12_2 is for cpu032II.
The llc will generate cpu032I cmp, jeq,
..., instructions when <cite>llc -mcpu=cpu032I</cite> while <cite>llc -mcpu=cpu032II</cite> will
generate slt, beq when meet &#8220;if else&#8221;, &#8220;while&#8221; and &#8220;for&#8221; flow control
statements.</p>
</div>
<div class="section" id="cpu0-verilog-language-changes">
<h3>Cpu0 Verilog language changes<a class="headerlink" href="#cpu0-verilog-language-changes" title="Permalink to this headline">¶</a></h3>
<p class="rubric">lbdex/cpu0_verilog/cpu0IIs.v</p>
<div class="highlight-c++"><pre>`define CPU0II
// TRACE: Display the memory contents of the loaded program and data
//`define TRACE 

`include "cpu0.v"

</pre>
</div>
<p>In addition to cpu0IIs.v, the &#8220;`ifdef CPU0II&#8221; in cpu0.v is added for extended
instructions, slt, beq and bne.</p>
</div>
<div class="section" id="run-the-cpu0ii">
<h3>Run the Cpu0II<a class="headerlink" href="#run-the-cpu0ii" title="Permalink to this headline">¶</a></h3>
<p>Run Chapter12_2/ with ch_run_backend.cpp to get result as below.
It match the output result as comments in ch_run_backend.cpp.</p>
<p class="rubric">lbdex/InputFiles/ch_run_backend.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;boot.cpp&quot;</span>

<span class="cp">#include &quot;print.h&quot;</span>

<span class="kt">int</span> <span class="nf">test_math</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_div</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_local_pointer</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_andorxornot</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_setxx</span><span class="p">();</span>
<span class="kt">bool</span> <span class="nf">test_load_bool</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_signed_char</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_unsigned_char</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_signed_short</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_unsigned_short</span><span class="p">();</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="nf">test_longlong</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_control1</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_madd</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">test_vararg</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_math</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>  <span class="c1">// a = 74</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_div</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>  <span class="c1">// a = 253</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_local_pointer</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>  <span class="c1">// a = 3</span>
  <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">test_load_bool</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>  <span class="c1">// a = 1</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_andorxornot</span><span class="p">();</span> <span class="c1">// a = 14</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_setxx</span><span class="p">();</span> <span class="c1">// a = 3</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_signed_char</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = -126</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_unsigned_char</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = 130</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_signed_short</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = -32766</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_unsigned_short</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = 32770</span>
  <span class="kt">long</span> <span class="kt">long</span> <span class="n">b</span> <span class="o">=</span> <span class="n">test_longlong</span><span class="p">();</span> <span class="c1">// 0x800000002</span>
  <span class="n">print_integer</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span> <span class="c1">// 393307</span>
  <span class="n">print_integer</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">b</span><span class="p">);</span> <span class="c1">// 16777222</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_control1</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>	<span class="c1">// a = 51</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="mi">2147483647</span><span class="p">);</span> <span class="c1">// test mod % (mult) from itoa.cpp</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483648</span><span class="p">);</span> <span class="c1">// test mod % (multu) from itoa.cpp</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_madd</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = 7</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test_vararg</span><span class="p">();</span>
  <span class="n">print_integer</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// a = 15</span>

  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;print.cpp&quot;</span>

<span class="kt">void</span> <span class="nf">print1_integer</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld $at, 8($sp)&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;st $at, 28672($0)&quot;</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">// For instruction IO</span>
<span class="c">void print2_integer(int x)</span>
<span class="c">{</span>
<span class="c">  asm(&quot;ld $at, 8($sp)&quot;);</span>
<span class="c">  asm(&quot;outw $tat&quot;);</span>
<span class="c">  return;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;ch4_1.cpp&quot;</span>
<span class="cp">#include &quot;ch4_3.cpp&quot;</span>
<span class="cp">#include &quot;ch4_5.cpp&quot;</span>
<span class="cp">#include &quot;ch7_1.cpp&quot;</span>
<span class="cp">#include &quot;ch7_2_2.cpp&quot;</span>
<span class="cp">#include &quot;ch7_3.cpp&quot;</span>
<span class="cp">#include &quot;ch7_4.cpp&quot;</span>
<span class="cp">#include &quot;ch8_1_1.cpp&quot;</span>
<span class="cp">#include &quot;ch9_1_4.cpp&quot;</span>
<span class="cp">#include &quot;ch9_3.cpp&quot;</span>

<span class="cm">/* result:</span>
<span class="cm">74</span>
<span class="cm">253</span>
<span class="cm">3</span>
<span class="cm">1</span>
<span class="cm">14</span>
<span class="cm">3</span>
<span class="cm">-126</span>
<span class="cm">130</span>
<span class="cm">-32766</span>
<span class="cm">32770</span>
<span class="cm">393307</span>
<span class="cm">16777222</span>
<span class="cm">51</span>
<span class="cm">2147483647</span>
<span class="cm">-2147483648</span>
<span class="cm">7</span>
<span class="cm">15</span>
<span class="cm">RET to PC &lt; 0, finished!</span>
<span class="cm">*/</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-77-203:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -mcpu<span class="o">=</span>cpu032II -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>obj
-stats ch_run_backend.bc -o ch_run_backend.cpu0.o
<span class="o">===</span>-------------------------------------------------------------------------<span class="o">===</span>
                          ... Statistics Collected ...
<span class="o">===</span>-------------------------------------------------------------------------<span class="o">===</span>
  ...
   5 del-jmp     - Number of useless jmp deleted
  ...

118-165-77-203:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llvm-objdump -d ch_run_backend.cpu0.o | tail -n +6| awk <span class="s1">&#39;{print &quot;/* &quot; $1</span>
<span class="s1">&quot; */\t&quot; $2 &quot; &quot; $3 &quot; &quot; $4 &quot; &quot; $5 &quot;\t/* &quot; $6&quot;\t&quot; $7&quot; &quot; $8&quot; &quot; $9&quot; &quot; $10 &quot;\t*/&quot;}&#39;</span> &gt;
../cpu0_verilog/redesign/cpu0.hex

JonathantekiiMac:InputFiles Jonathan<span class="nv">$ </span><span class="nb">cd</span> ../cpu0_verilog/
JonathantekiiMac:redesign Jonathan<span class="nv">$ </span>iverilog -o cpu0IIs cpu0IIs.v
JonathantekiiMac:redesign Jonathan<span class="nv">$ </span>./cpu0IIs
taskInterrupt<span class="o">(</span>001<span class="o">)</span>
74
253
3
1
14
3
-126
130
-32766
32770
393307
16777222
51
2147483647
-2147483648
15
RET to PC &lt; 0, finished!
</pre></div>
</div>
<p>Run with ch8_1_1.cpp, it reduces some branches from pair instructions &#8220;CMP, JXX&#8221;
to 1 single instruction ether is BEQ or BNE, as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-77-203:InputFiles Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
bin/Debug/llc -march<span class="o">=</span>cpu0 -mcpu<span class="o">=</span>cpu032II -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm
ch8_1_1.bc -o ch8_1_1.cpu0.s
118-165-77-203:InputFiles Jonathan<span class="nv">$ </span>cat ch8_1_1.cpu0.s
        .section .mdebug.abi32
        .previous
        .file <span class="s2">&quot;ch8_1_1.bc&quot;</span>
        .text
        .globl        _Z13test_control1v
        .align        2
        .type _Z13test_control1v,@function
        .ent  _Z13test_control1v      <span class="c"># @_Z13test_control1v</span>
_Z13test_control1v:
        .cfi_startproc
        .frame        <span class="nv">$fp</span>,48,<span class="nv">$lr</span>
        .mask         0x00000800,-4
        .set  noreorder
        .set  nomacro
<span class="c"># BB#0:                                 # %entry</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -48
<span class="nv">$tmp3</span>:
        .cfi_def_cfa_offset 48
        st    <span class="nv">$fp</span>, 44<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Spill</span>
<span class="nv">$tmp4</span>:
        .cfi_offset 11, -4
        addu  <span class="nv">$fp</span>, <span class="nv">$sp</span>, <span class="nv">$zero</span>
<span class="nv">$tmp5</span>:
        .cfi_def_cfa_register 11
        addiu <span class="nv">$3</span>, <span class="nv">$zero</span>, 0
        st    <span class="nv">$3</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 1
        st    <span class="nv">$2</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 2
        st    <span class="nv">$4</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 3
        st    <span class="nv">$4</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 4
        st    <span class="nv">$4</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 5
        st    <span class="nv">$4</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 6
        st    <span class="nv">$4</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 7
        st    <span class="nv">$4</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 8
        st    <span class="nv">$4</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$zero</span>, 9
        st    <span class="nv">$4</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$4</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        bne   <span class="nv">$4</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_2</span>
<span class="c"># BB#1:                                 # %if.then</span>
        ld    <span class="nv">$4</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_2</span>:                                 <span class="c"># %if.end</span>
        ld    <span class="nv">$4</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        beq   <span class="nv">$4</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_4</span>
<span class="c"># BB#3:                                 # %if.then2</span>
        ld    <span class="nv">$4</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_4</span>:                                 <span class="c"># %if.end4</span>
        ld    <span class="nv">$4</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slti  <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        bne   <span class="nv">$4</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_6</span>
<span class="c"># BB#5:                                 # %if.then6</span>
        ld    <span class="nv">$4</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_6</span>:                                 <span class="c"># %if.end8</span>
        ld    <span class="nv">$4</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slti  <span class="nv">$4</span>, <span class="nv">$4</span>, 0
        bne   <span class="nv">$4</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_8</span>
<span class="c"># BB#7:                                 # %if.then10</span>
        ld    <span class="nv">$4</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_8</span>:                                 <span class="c"># %if.end12</span>
        ld    <span class="nv">$4</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$5</span>, <span class="nv">$zero</span>, -1
        slt   <span class="nv">$4</span>, <span class="nv">$5</span>, <span class="nv">$4</span>
        bne   <span class="nv">$4</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_10</span>
<span class="c"># BB#9:                                 # %if.then14</span>
        ld    <span class="nv">$4</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$4</span>, <span class="nv">$4</span>, 1
        st    <span class="nv">$4</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_10</span>:                                <span class="c"># %if.end16</span>
        ld    <span class="nv">$4</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slt   <span class="nv">$3</span>, <span class="nv">$3</span>, <span class="nv">$4</span>
        bne   <span class="nv">$3</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_12</span>
<span class="c"># BB#11:                                # %if.then18</span>
        ld    <span class="nv">$3</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$3</span>, <span class="nv">$3</span>, 1
        st    <span class="nv">$3</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_12</span>:                                <span class="c"># %if.end20</span>
        ld    <span class="nv">$3</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slt   <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        bne   <span class="nv">$2</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_14</span>
<span class="c"># BB#13:                                # %if.then22</span>
        ld    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_14</span>:                                <span class="c"># %if.end24</span>
        ld    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slti  <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        bne   <span class="nv">$2</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_16</span>
<span class="c"># BB#15:                                # %if.then26</span>
        ld    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_16</span>:                                <span class="c"># %if.end28</span>
        ld    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        slt   <span class="nv">$2</span>, <span class="nv">$3</span>, <span class="nv">$2</span>
        beq   <span class="nv">$2</span>, <span class="nv">$zero</span>, <span class="nv">$BB0_18</span>
<span class="c"># BB#17:                                # %if.then30</span>
        ld    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_18</span>:                                <span class="c"># %if.end32</span>
        ld    <span class="nv">$2</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$3</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        beq   <span class="nv">$3</span>, <span class="nv">$2</span>, <span class="nv">$BB0_20</span>
<span class="c"># BB#19:                                # %if.then34</span>
        ld    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_20</span>:                                <span class="c"># %if.end36</span>
        ld    <span class="nv">$2</span>, 36<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$3</span>, 40<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$3</span>, <span class="nv">$2</span>
        ld    <span class="nv">$3</span>, 32<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 28<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 24<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        ld    <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addu  <span class="nv">$2</span>, <span class="nv">$2</span>, <span class="nv">$3</span>
        addu  <span class="nv">$sp</span>, <span class="nv">$fp</span>, <span class="nv">$zero</span>
        ld    <span class="nv">$fp</span>, 44<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Reload</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 48
        ret   <span class="nv">$lr</span>
        .set  macro
        .set  reorder
        .end  _Z13test_control1v
<span class="nv">$tmp6</span>:
        .size _Z13test_control1v, <span class="o">(</span><span class="nv">$tmp6</span><span class="o">)</span>-_Z13test_control1v
        .cfi_endproc
</pre></div>
</div>
<p>The ch12_3.cpp is written in assembly for AsmParser test. You can check if it
will generate the obj.</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="runbackend.html">Run backend</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="lld.html">LLD for Cpu0</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>